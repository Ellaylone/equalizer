<!DOCTYPE html>
<html>
<head>
	<title>Equalizr</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<style>
		.equalizer-wrapper {
			float:left; margin: 0 20px 20px 0;
		}
		.equalizer {
			overflow: hidden;
			border:1px solid #ddd;
		}
		.equalizer.small {
			width: 100px;
			height: 100px;
		}
		.equalizer.normal {
			width: 200px;
			height: 200px;
		}
		.equalizer.big {
			width: 300px;
			height: 300px;
		}
	</style>
	<script>
	(function($){
		$.fn.equalizer = function(options){
			$.extend($.fn.equalizer.settings, $.fn.equalizer.defaults);
			$.extend($.fn.equalizer.settings, options);
			return this.each(function(){
				$.extend($.fn.equalizer.settings, {selector: $(this)});
				$.fn.equalizer.setEqualizer($.fn.equalizer.settings);
					$.fn.equalizer.readyEqualizer($.fn.equalizer.settings);
					$.fn.equalizer.resetEqualizer($.fn.equalizer.settings);
				setTimeout(function() {console.log(1);
				}, 1000);
			});
		};
		$.fn.equalizer.settings = {};
		$.fn.equalizer.defaults = {
			timeout: 1000,
			colWidth: 1
		};
		$.fn.equalizer.setEqualizer = function(settings){
			settings.selector.css({
				verticalAlign: 'bottom',
				lineHeight: settings.selector.height() + 'px'
			});
			var colQuantity = Math.ceil(settings.selector.width()/settings.colWidth);
			var cols = new Array(colQuantity);
			for (var i = 0; i < cols.length; i++) {
				var span = $('<span/>').appendTo(settings.selector);
				span.css({
					verticalAlign: 'bottom',
					display: 'inline-block',

					fontSize: 0,
					lineHeight: 0,

					width: settings.colWidth,
					background: 'pink',
					borderTop: '2px solid red'
				});
			}
		}
		$.fn.equalizer.resetEqualizer = function(settings){
			console.log('1')
			// $.extend($.fn.equalizer.settings);
			var equ = settings.selector;
			var spans = equ.find('span');
			var spansArray = jQuery.makeArray(spans);
			var length = spansArray.length;
			var randomArray = [];
			spans.animate(
				{height: equ.height()/2},
				settings.timeout,
				'linear'
			);
			for(var i = 0; i < length; i++)
			{
				randomArray[i] = Math.round(equ.height() * Math.random());
			}
			spans.each(function (i) {
				$(this).animate(
					{height: randomArray[i]},
					10*Math.random(),
					'swing'
					);
				});
			//window.setTimeout(function () { myFunc() }, 300);
		};
		$.fn.equalizer.runEqualizer = function(settings){
		};
		$.fn.equalizer.readyEqualizer = function(settings){
			// var start = new Date();
			var spans = settings.selector.find('span');
			// var end = new Date();
			// console.log(end.valueOf() - start.valueOf());
			spans.each(function (i) {
				var colHeight = Math.round(settings.selector.height() * Math.random());
				$(this).height(colHeight);
			});
		};
	}(jQuery));
		$(document).ready(function(){
			$('#eq .equalizer').equalizer({
				timeout: 1000,
				colWidth: 2
			});
		});
		function setEqualizer(selector, timeout, colWidth) {
			if (!colWidth) {
				colWidth = 1;
			}
			$(selector).css({
				verticalAlign: 'bottom',
				lineHeight: $(selector).height() + 'px'
			});
			
          // Кол-во столбиков
          var colQuantity = Math.ceil($(selector).width()/colWidth);
          var cols = new Array(colQuantity);
          for (var i = 0; i < cols.length; i++) {
          	var span = $('<span/>').appendTo(selector);
          	span.css({
          		verticalAlign: 'bottom',
          		display: 'inline-block',
          		
          		fontSize: 0,
          		lineHeight: 0,
          		
          		width: colWidth,
          		background: 'pink',
          		borderTop: '2px solid red'
          	});
          }
          
          // run_equalizer(selector, timeout);
      }
      
      function reset_equalizer (equalizer)
      {
      	
      }
      
      function run_equalizer (selector, timeout) {
      	var equ = $(selector);
      	var spans = $(selector).find(' span');
		  //function decreaseEqualizer {
		  	spans.each(function (i) {
		  		var colHeight = Math.round($(selector).height() * Math.random());
		  		$(this).height(colHeight);
		  	});
		  	var spansArray = jQuery.makeArray(spans);
		  	var length = spansArray.length;
		  	var randomArray = [];
		  	
		  	function myFunc() {
		  		
		  		spans.animate(
		  			{height: equ.height()/2},
		  			timeout,
		  			'linear'
		  			)
		  		for(var i = 0; i < length; i++)
		  		{
		  			randomArray[i] = Math.round(equ.height() * Math.random());
		  		}
		  		spans.each(function (i) {
		  			
				  //var colHeight = Math.round($(selector).height() * Math.random());
				  $(this).animate(
				  	{height: randomArray[i]},
				  	10*Math.random(),
				  	'swing'
				  	);
				});
			  //window.setTimeout(function () { myFunc() }, 300);
			};
			
		  //myFunc();
		  window.setInterval(function() {myFunc() }, 1000);
		}
		jQuery.fn.doOnce = function( func ) {
			this.length && func.apply( this );
			return this;
		}
		
		window.onload = function () {
			setEqualizer('#eq_1 .equalizer', 1000, 2);
			setEqualizer('#eq_2 .equalizer', 1000, 2);
			setEqualizer('#eq_3 .equalizer', 1000, 2);
			
			setInterval(setEqualizer('#eq_1 .equalizer', 1000, 2),500);
		}
		
	</script>
</head>
<body>
	<h1>Equalizers</h1>
	<div id="eq" class="equalizer-wrapper">
		<h2>Zero</h2>
		<div class="equalizer big"></div>
	</div>
	<div id="eq_1" class="equalizer-wrapper">
		<h2>First</h2>
		<div class="equalizer small"></div>
	</div>
	<div id="eq_2" class="equalizer-wrapper">
		<h2>Second</h2>
		<div class="equalizer normal"></div>
	</div>
	<div id="eq_3" class="equalizer-wrapper">
		<h2>Third</h2>
		<div class="equalizer big"></div>
	</div>
</body>
</html>